---
- name: "[DEBUG] New user values"
  ansible.builtin.debug:
    msg:
      - "New user name: {{ new_user_name }}"
      - "New user comment: {{ new_user_comment | default('Created by Ansible') }}"
      - "New user shell: {{ new_user_shell | default('/bin/bash') }}"
      - "New user generated SSH key path (on remote): {{ new_user_ssh_keypath | default('.ssh/id_rsa') }}"

- name: "Check if docker group exists"
  ansible.builtin.getent:
    database: group
    key: docker
  register: docker_group_info
  failed_when: false
  changed_when: false

- name: "Check if user group exists"
  ansible.builtin.getent:
    database: group
    key: "{{ new_user_name }}"
  register: user_group_info
  failed_when: false
  changed_when: false

- name: "Create user group"
  ansible.builtin.group:
    name: "{{ new_user_name }}"
    state: present
  become: true
  # when:
  #   - user_group_info is not defined or user_group_info is none
  #   - gid_check.stdout == ""

- name: "Create docker group"
  ansible.builtin.group:
    name: docker
    state: present
    gid: 999
  become: true
  # when:
  #   - docker_group_info is not defined or docker_group_info is none
  #   - gid_check.stdout == ""

- name: "Create new user"
  ansible.builtin.user:
    name: "{{ new_user_name }}"
    comment: "{{ new_user_comment | default('Created by Ansible')}}"
    groups: docker,{{ new_user_name }}
    create_home: true
    shell: "{{ new_user_shell | default('/bin/bash') }}"
    append: true
    state: present
    generate_ssh_key: "{{ new_user_generate_ssh_key | default(true) }}"
    ssh_key_bits: 4096
    ssh_key_file: "{{ new_user_ssh_keypath | default('.ssh/id_rsa') }}"
  become: true
