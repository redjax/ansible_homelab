---
- name: Ensure zabbix user and dirs
  ansible.builtin.user:
    name: zabbix
    system: true
    shell: /usr/sbin/nologin
    home: /var/lib/zabbix
  become: true
  failed_when: false
  ignore_errors: true

- name: Ensure logging and runtime dirs
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: zabbix
    group: zabbix
    mode: "0755"
  loop:
    - /var/log/zabbix
    - /run/zabbix
  become: true
  failed_when: false
  ignore_errors: true

- name: Backup existing Zabbix agent2 config if present
  ansible.builtin.copy:
    src: /etc/zabbix/zabbix_agent2.conf
    dest: "/etc/zabbix/zabbix_agent2.conf.bak.{{ ansible_date_time.epoch }}"
    remote_src: true
  ignore_errors: true
  become: true

- name: Create TLS PSK file when enabled
  ansible.builtin.copy:
    dest: "{{ zabbix_agent_tls_psk_file }}"
    content: "{{ zabbix_agent_tls_psk }}"
    owner: zabbix
    group: zabbix
    mode: "0600"
  become: true
  when: zabbix_agent_enable_tls | bool

- name: Deploy generated Zabbix agent2 config
  ansible.builtin.template:
    src: zabbix_agent2.conf.j2
    dest: /etc/zabbix/zabbix_agent2.conf
    owner: zabbix
    group: zabbix
    mode: "0644"
  become: true
  notify: Restart zabbix agent2
